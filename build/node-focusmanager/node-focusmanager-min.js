YUI.add("node-focusmanager",function(h,e){var d="activeDescendant",r="id",u="disabled",l="tabIndex",c="focused",a="focusClass",n="circular",o="host",t={37:!0,38:!0,39:!0,40:!0},i={a:!0,button:!0,input:!0,object:!0},_=h.Lang,f=h.UA,s=function(){s.superclass.constructor.apply(this,arguments)};s.ATTRS={focused:{value:!1,readOnly:!0},descendants:{getter:function(e){return this.get(o).all(e)}},activeDescendant:{setter:function(e){var t,s,n=_.isNumber,i=h.Attribute.INVALID_VALUE,a=this._descendantsMap,c=this._descendants,n=n(e)?t=e:e instanceof h.Node&&a&&n(t=a[e.get(r)])?t:i;return n=c&&(s=c.item(t))&&s.get("disabled")?i:n}},keys:{value:{next:null,previous:null}},focusClass:{},circular:{value:!0}},h.extend(s,h.Plugin.Base,{_stopped:!0,_descendants:null,_descendantsMap:null,_focusedNode:null,_lastNodeIndex:0,_eventHandlers:null,_initDescendants:function(){var e,t,s,n=this.get("descendants"),i={},a=-1,c=this.get(d),o=0;if(_.isUndefined(c)&&(c=-1),n){for(e=n.size(),o=0;o<e;o++)t=n.item(o),-1!==a||t.get(u)||(a=o),c<0&&0===parseInt(t.getAttribute(l,2),10)&&(c=o),t&&t.set(l,-1),(s=t.get(r))||(s=h.guid(),t.set(r,s)),i[s]=o;(t=n.item(c=c<0?0:c))&&!t.get(u)||(t=n.item(a),c=a),this._lastNodeIndex=e-1,this._descendants=n,this._descendantsMap=i,this.set(d,c),t&&t.set(l,0)}},_isDescendant:function(e){return e.get(r)in this._descendantsMap},_removeFocusClass:function(){var e,t=this._focusedNode,s=this.get(a);s&&(e=_.isString(s)?s:s.className),t&&e&&t.removeClass(e)},_detachKeyHandler:function(){var e=this._prevKeyHandler,t=this._nextKeyHandler;e&&e.detach(),t&&t.detach()},_preventScroll:function(e){t[e.keyCode]&&this._isDescendant(e.target)&&e.preventDefault()},_fireClick:function(e){var t=e.target,s=t.get("nodeName").toLowerCase();13!==e.keyCode||i[s]&&("a"!==s||t.getAttribute("href"))||t.simulate("click")},_attachKeyHandler:function(){this._detachKeyHandler();var e=this.get("keys.next"),t=this.get("keys.previous"),s=this.get(o),n=this._eventHandlers;t&&(this._prevKeyHandler=h.on("key",h.bind(this._focusPrevious,this),s,t)),e&&(this._nextKeyHandler=h.on("key",h.bind(this._focusNext,this),s,e)),f.opera&&n.push(s.on("keypress",this._preventScroll,this)),f.opera||n.push(s.on("keypress",this._fireClick,this))},_detachEventHandlers:function(){this._detachKeyHandler();var e=this._eventHandlers;e&&(h.Array.each(e,function(e){e.detach()}),this._eventHandlers=null)},_attachEventHandlers:function(){var e,t,s=this._descendants;s&&s.size()&&(e=this._eventHandlers||[],s=this.get(o).get("ownerDocument"),0===e.length&&(e.push(s.on("focus",this._onDocFocus,this)),e.push(s.on("mousedown",this._onDocMouseDown,this)),e.push(this.after("keysChange",this._attachKeyHandler)),e.push(this.after("descendantsChange",this._initDescendants)),e.push(this.after("activeDescendantChange",this._afterActiveDescendantChange)),t=this.after("focusedChange",h.bind(function(e){e.newVal&&(this._attachKeyHandler(),t.detach())},this)),e.push(t)),this._eventHandlers=e)},_onDocMouseDown:function(e){var t,s=this.get(o),n=e.target,i=s.contains(n),a=function(e){var t=!1;return t=!e.compareTo(s)?this._isDescendant(e)?e:a.call(this,e.get("parentNode")):t};i&&((t=a.call(this,n))?n=t:!t&&this.get(c)&&(this._set(c,!1),this._onDocFocus(e))),i&&this._isDescendant(n)?this.focus(n):!f.webkit||!this.get(c)||i&&this._isDescendant(n)||(this._set(c,!1),this._onDocFocus(e))},_onDocFocus:function(e){var t,s=this._focusTarget||e.target,n=this.get(c),i=this.get(a),e=this._focusedNode;this._focusTarget&&(this._focusTarget=null),this.get(o).contains(s)?(t=this._isDescendant(s),!n&&t?n=!0:n&&!t&&(n=!1)):n=!1,i&&(!e||e.compareTo(s)&&n||this._removeFocusClass(),t&&n&&(i.fn?(s=i.fn(s)).addClass(i.className):s.addClass(i),this._focusedNode=s)),this._set(c,n)},_focusNext:function(e,t){var s=t||this.get(d);this._isDescendant(e.target)&&s<=this._lastNodeIndex&&((s+=1)===this._lastNodeIndex+1&&this.get(n)&&(s=0),(t=this._descendants.item(s))&&(t.get("disabled")?this._focusNext(e,s):this.focus(s))),this._preventScroll(e)},_focusPrevious:function(e,t){var s=t||this.get(d);this._isDescendant(e.target)&&0<=s&&(-1===(s-=1)&&this.get(n)&&(s=this._lastNodeIndex),(t=this._descendants.item(s))&&(t.get("disabled")?this._focusPrevious(e,s):this.focus(s))),this._preventScroll(e)},_afterActiveDescendantChange:function(e){var t=this._descendants.item(e.prevVal);t&&t.set(l,-1),(t=this._descendants.item(e.newVal))&&t.set(l,0)},initializer:function(e){this.start()},destructor:function(){this.stop(),this.get(o).focusManager=null},focus:function(e){_.isUndefined(e)&&(e=this.get(d)),this.set(d,e,{src:"UI"});e=this._descendants.item(this.get(d));e&&(e.focus(),f.opera&&"button"===e.get("nodeName").toLowerCase()&&(this._focusTarget=e))},blur:function(){var e;this.get(c)&&((e=this._descendants.item(this.get(d)))&&(e.blur(),this._removeFocusClass()),this._set(c,!1,{src:"UI"}))},start:function(){this._stopped&&(this._initDescendants(),this._attachEventHandlers(),this._stopped=!1)},stop:function(){this._stopped||(this._detachEventHandlers(),this._descendants=null,this._focusedNode=null,this._lastNodeIndex=0,this._stopped=!0)},refresh:function(){this._initDescendants(),this._eventHandlers||this._attachEventHandlers()}}),s.NAME="nodeFocusManager",s.NS="focusManager",h.namespace("Plugin"),h.Plugin.NodeFocusManager=s},"@VERSION@",{requires:["attribute","node","plugin","node-event-simulate","event-key","event-focus"]});