YUI.add("uploader-queue",function(a,e){var r=function(){this.queuedFiles=[],this.uploadRetries={},this.numberOfUploads=0,this.currentUploadedByteValues={},this.currentFiles={},this.totalBytesUploaded=0,this.totalBytes=0,r.superclass.constructor.apply(this,arguments)};a.extend(r,a.Base,{_currentState:r.STOPPED,initializer:function(){},_uploadStartHandler:function(e){var t=e;t.file=e.target,t.originEvent=e,this.fire("uploadstart",t)},_uploadErrorHandler:function(e){var t,i,s=this.get("errorAction"),a=e;a.file=e.target,a.originEvent=e,--this.numberOfUploads,delete this.currentFiles[e.target.get("id")],this._detachFileEvents(e.target),e.target.cancelUpload(),s===r.STOP?this.pauseUpload():s===r.RESTART_ASAP?(t=e.target.get("id"),(i=this.uploadRetries[t]||0)<this.get("retryCount")&&(this.uploadRetries[t]=i+1,this.addToQueueTop(e.target)),this._startNextFile()):s===r.RESTART_AFTER&&(t=e.target.get("id"),(i=this.uploadRetries[t]||0)<this.get("retryCount")&&(this.uploadRetries[t]=i+1,this.addToQueueBottom(e.target)),this._startNextFile()),this.fire("uploaderror",a)},_startNextFile:function(){var e,t,i;0<this.queuedFiles.length&&(t=(e=this.queuedFiles.shift()).get("id"),i=(i=this.get("perFileParameters")).hasOwnProperty(t)?i[t]:i,this.currentUploadedByteValues[t]=0,e.on("uploadstart",this._uploadStartHandler,this),e.on("uploadprogress",this._uploadProgressHandler,this),e.on("uploadcomplete",this._uploadCompleteHandler,this),e.on("uploaderror",this._uploadErrorHandler,this),e.on("uploadcancel",this._uploadCancelHandler,this),e.set("xhrHeaders",this.get("uploadHeaders")),e.set("xhrWithCredentials",this.get("withCredentials")),e.startUpload(this.get("uploadURL"),i,this.get("fileFieldName")),this._registerUpload(e))},_registerUpload:function(e){this.numberOfUploads+=1,this.currentFiles[e.get("id")]=e},_unregisterUpload:function(e){0<this.numberOfUploads&&--this.numberOfUploads,delete this.currentFiles[e.get("id")],delete this.uploadRetries[e.get("id")],this._detachFileEvents(e)},_detachFileEvents:function(e){e.detach("uploadstart",this._uploadStartHandler),e.detach("uploadprogress",this._uploadProgressHandler),e.detach("uploadcomplete",this._uploadCompleteHandler),e.detach("uploaderror",this._uploadErrorHandler),e.detach("uploadcancel",this._uploadCancelHandler)},_uploadCompleteHandler:function(e){this._unregisterUpload(e.target),this.totalBytesUploaded+=e.target.get("size"),delete this.currentUploadedByteValues[e.target.get("id")],0<this.queuedFiles.length&&this._currentState===r.UPLOADING&&this._startNextFile();var t=e,i=this.totalBytesUploaded,s=Math.min(100,Math.round(1e4*i/this.totalBytes)/100);t.file=e.target,t.originEvent=e,a.each(this.currentUploadedByteValues,function(e){i+=e}),this.fire("totaluploadprogress",{bytesLoaded:i,bytesTotal:this.totalBytes,percentLoaded:s}),this.fire("uploadcomplete",t),0===this.queuedFiles.length&&this.numberOfUploads<=0&&(this.fire("alluploadscomplete"),this._currentState=r.STOPPED)},_uploadCancelHandler:function(e){var t=e;t.originEvent=e,t.file=e.target,this.fire("uploadcancel",t)},_uploadProgressHandler:function(e){this.currentUploadedByteValues[e.target.get("id")]=e.bytesLoaded;var t=e,i=this.totalBytesUploaded,s=Math.min(100,Math.round(1e4*i/this.totalBytes)/100);t.originEvent=e,t.file=e.target,this.fire("uploadprogress",t),a.each(this.currentUploadedByteValues,function(e){i+=e}),this.fire("totaluploadprogress",{bytesLoaded:i,bytesTotal:this.totalBytes,percentLoaded:s})},startUpload:function(){for(this.queuedFiles=this.get("fileList").slice(0),this.numberOfUploads=0,this.currentUploadedByteValues={},this.currentFiles={},this.totalBytesUploaded=0,this._currentState=r.UPLOADING;this.numberOfUploads<this.get("simUploads")&&0<this.queuedFiles.length;)this._startNextFile()},pauseUpload:function(){this._currentState=r.STOPPED},restartUpload:function(){for(this._currentState=r.UPLOADING;this.numberOfUploads<this.get("simUploads");)this._startNextFile()},forceReupload:function(e){var t=e.get("id");this.currentFiles.hasOwnProperty(t)&&(e.cancelUpload(),this._unregisterUpload(e),this.addToQueueTop(e),this._startNextFile())},addToQueueTop:function(e){this.queuedFiles.unshift(e)},addToQueueBottom:function(e){this.queuedFiles.push(e)},cancelUpload:function(e){var t,i,s;if(e){if(t=e.get("id"),this.currentFiles[t])this.currentFiles[t].cancelUpload(),this._unregisterUpload(this.currentFiles[t]),this._currentState===r.UPLOADING&&this._startNextFile();else for(i=0,len=this.queuedFiles.length;i<len;i++)if(this.queuedFiles[i].get("id")===t){this.queuedFiles.splice(i,1);break}}else{for(s in this.currentFiles)this.currentFiles[s].cancelUpload(),this._unregisterUpload(this.currentFiles[s]);this.currentUploadedByteValues={},this.currentFiles={},this.totalBytesUploaded=0,this.fire("alluploadscancelled"),this._currentState=r.STOPPED}}},{CONTINUE:"continue",STOP:"stop",RESTART_ASAP:"restartasap",RESTART_AFTER:"restartafter",STOPPED:"stopped",UPLOADING:"uploading",NAME:"uploaderqueue",ATTRS:{simUploads:{value:2,validator:function(e){return 1<=e&&e<=5}},errorAction:{value:"continue",validator:function(e){return e===r.CONTINUE||e===r.STOP||e===r.RESTART_ASAP||e===r.RESTART_AFTER}},bytesUploaded:{readOnly:!0,value:0},bytesTotal:{readOnly:!0,value:0},fileList:{value:[],lazyAdd:!1,setter:function(e){return a.Array.each(e,function(e){this.totalBytes+=e.get("size")},this),e}},fileFieldName:{value:"Filedata"},uploadURL:{value:""},uploadHeaders:{value:{}},withCredentials:{value:!0},perFileParameters:{value:{}},retryCount:{value:3}}}),a.namespace("Uploader"),a.Uploader.Queue=r},"@VERSION@",{requires:["base"]});